<!-- start page dashboard -->
<div class="page-wrapper">
    <!-- Page header -->
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <!-- Page pre-title -->
                    <div class="page-pretitle" data-translate="overview">
                        Overview
                    </div>
                    <h2 class="page-title" data-translate="process_list">
                        Process List
                    </h2>
                </div>
                <div class="col-auto ms-auto">
                    <a href="#" class="btn btn-pill bg-green-lt" data-bs-toggle="modal" data-bs-target="#new-deploy">
                        <!-- Download SVG icon from http://tabler-icons.io/i/cube-plus -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M21 12.5v-4.509a1.98 1.98 0 0 0 -1 -1.717l-7 -4.008a2.016 2.016 0 0 0 -2 0l-7 4.007c-.619 .355 -1 1.01 -1 1.718v8.018c0 .709 .381 1.363 1 1.717l7 4.008a2.016 2.016 0 0 0 2 0" />
                            <path d="M12 22v-10" />
                            <path d="M12 12l8.73 -5.04" />
                            <path d="M3.27 6.96l8.73 5.04" />
                            <path d="M16 19h6" />
                            <path d="M19 16v6" />
                        </svg>
                        <span class="" data-translate="deploy_new_app">Deploy new app</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Page body -->
    <div class="page-body">
        <div class="container-xl">
            <div class="col-md-12">
                <div class="row row-cards">
                    <div class="space-y">
                        <% apps.forEach(function (app) {%>
                        <div class="card card-stacked">
                            <div class="row g-0">
                                <div class="col-auto">
                                    <div class="card-body">
                                        <div class="avatar avatar-xl">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-nodejs">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                <path d="M9 9v8.044a2 2 0 0 1 -2.996 1.734l-1.568 -.9a3 3 0 0 1 -1.436 -2.561v-6.635a3 3 0 0 1 1.436 -2.56l6 -3.667a3 3 0 0 1 3.128 0l6 3.667a3 3 0 0 1 1.436 2.561v6.634a3 3 0 0 1 -1.436 2.56l-6 3.667a3 3 0 0 1 -3.128 0" />
                                                <path d="M17 9h-3.5a1.5 1.5 0 0 0 0 3h2a1.5 1.5 0 0 1 0 3h-3.5" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card-body ps-0">
                                        <div class="row">
                                            <div class="col">
                                                <h3 class="mb-0">
                                                    <a href="/apps/<%= app.name %>">
                                                        <h2 class="page-title">
                                                            <svg class="icon icon-tabler icon-tabler-cube" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                                </path>
                                                                <polyline points="12 3 20 7.5 20 16.5 12 21 4 16.5 4 7.5 12 3">
                                                                </polyline>
                                                                <line x1="12" x2="20" y1="12" y2="7.5">
                                                                </line>
                                                                <line x1="12" x2="12" y1="12" y2="21">
                                                                </line>
                                                                <line x1="12" x2="4" y1="12" y2="7.5">
                                                                </line>
                                                            </svg>
                                                            <%= app.name %>
                                                        </h2>
                                                    </a>
                                                </h3>
                                            </div>
                                            <div class="col-auto fs-2">
                                                <% if(app.status === "online"){ %>
                                                <span class="status-indicator status-green status-indicator-animated">
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                </span>
                                                <% } else if(app.status === "launching" || app.status === "on-launch-status"){ %>
                                                <span class="status-indicator status-yellow status-indicator-animated">
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                </span>
                                                <% } else{ %>
                                                <span class="status-indicator status-red status-indicator-animated">
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                    <span class="status-indicator-circle">
                                                    </span>
                                                </span>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md">
                                                <div class="mt-3 list-inline list-inline-dots mb-0 text-secondary d-sm-block d-none">
                                                    <div class="list-inline-item">
                                                        <!-- Download SVG icon from http://tabler-icons.io/i/license -->
                                                        <svg class="icon icon-tabler icons-tabler-outline icon-tabler-cpu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                            </path>
                                                            <path d="M5 5m0 1a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1 -1z">
                                                            </path>
                                                            <path d="M9 9h6v6h-6z">
                                                            </path>
                                                            <path d="M3 10h2">
                                                            </path>
                                                            <path d="M3 14h2">
                                                            </path>
                                                            <path d="M10 3v2">
                                                            </path>
                                                            <path d="M14 3v2">
                                                            </path>
                                                            <path d="M21 10h-2">
                                                            </path>
                                                            <path d="M21 14h-2">
                                                            </path>
                                                            <path d="M14 21v-2">
                                                            </path>
                                                            <path d="M10 21v-2">
                                                            </path>
                                                        </svg>
                                                        <span data-translate="cpu">CPU</span>:
                                                        <%= app.cpu %> %
                                                    </div>
                                                    <div class="list-inline-item">
                                                        <!-- Download SVG icon from http://tabler-icons.io/i/map-pin -->
                                                        <svg class="icon icon-tabler icon-tabler-device-desktop-analytics" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                            </path>
                                                            <rect height="12" rx="1" width="18" x="3" y="4">
                                                            </rect>
                                                            <path d="M7 20h10">
                                                            </path>
                                                            <path d="M9 16v4">
                                                            </path>
                                                            <path d="M15 16v4">
                                                            </path>
                                                            <path d="M9 12v-4">
                                                            </path>
                                                            <path d="M12 12v-1">
                                                            </path>
                                                            <path d="M15 12v-2">
                                                            </path>
                                                            <path d="M12 12v-1">
                                                            </path>
                                                        </svg>
                                                        <span data-translate="memory">Memory</span>:
                                                        <%= app.memory %>
                                                    </div>
                                                    <div class="list-inline-item">
                                                        <!-- Download SVG icon from http://tabler-icons.io/i/map-pin -->
                                                        <svg class="icon icon-tabler icon-tabler-calendar-time" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                            </path>
                                                            <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4">
                                                            </path>
                                                            <circle cx="18" cy="18" r="4">
                                                            </circle>
                                                            <path d="M15 3v4">
                                                            </path>
                                                            <path d="M7 3v4">
                                                            </path>
                                                            <path d="M3 11h16">
                                                            </path>
                                                            <path d="M18 16.496v1.504l1 1">
                                                            </path>
                                                        </svg>
                                                        <span data-translate="uptime">Uptime</span>:
                                                        <%= app.uptime %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-auto">
                                                <div class="mt-3 badges">
                                                    <% if(app.status === "online"){ %>
                                                    <button class="badge bg-azure-lt" onclick="pm2AppAction('<%= app.name %>', 'reload')">
                                                        <span>
                                                            <svg class="icon icon-tabler icons-tabler-outline icon-tabler-reload" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                                </path>
                                                                <path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747">
                                                                </path>
                                                                <path d="M20 4v5h-5">
                                                                </path>
                                                            </svg>
                                                            <span data-translate="reload">Reload</span>
                                                        </span>
                                                    </button>
                                                    <button class="badge bg-green-lt" onclick="pm2AppAction('<%= app.name %>', 'restart')">
                                                        <span>
                                                            <svg class="icon icon-tabler icons-tabler-outline icon-tabler-refresh" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                                </path>
                                                                <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4">
                                                                </path>
                                                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4">
                                                                </path>
                                                            </svg>
                                                            <span data-translate="restart">Restart</span>
                                                        </span>
                                                    </button>
                                                    <button class="badge bg-red-lt" onclick="pm2AppAction('<%= app.name %>', 'stop')">
                                                        <span>
                                                            <svg class="icon icon-tabler icons-tabler-outline icon-tabler-player-stop" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                                </path>
                                                                <path d="M5 5m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z">
                                                                </path>
                                                            </svg>
                                                            <span data-translate="stop">Stop</span>
                                                        </span>
                                                    </button>
                                                    <% } else{ %>
                                                    <button class="badge bg-green-lt" onclick="pm2AppAction('<%= app.name %>', 'restart')">
                                                        <span>
                                                            <svg class="icon icon-tabler icons-tabler-outline icon-tabler-player-play" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M0 0h24v24H0z" fill="none" stroke="none">
                                                                </path>
                                                                <path d="M7 4v16l13 -8z">
                                                                </path>
                                                            </svg>
                                                            <span data-translate="start">Start</span>
                                                        </span>
                                                    </button>
                                                    <% } %>
                                                    <button class="badge bg-red-lt" onclick="pm2AppAction('<%= app.name %>', 'delete')">
                                                        <span>
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-minus">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                                <path d="M5 12l14 0" />
                                                            </svg>
                                                            <span data-translate="delete">Delete</span>
                                                        </span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% })%>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- modal new deploy -->
<div class="modal modal-blur fade" id="new-deploy" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" data-translate="deploy_new_app">Deploy new app</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label required" data-translate="deploy_app_name">App Name</label>
                    <input type="text" class="form-control" id="app-name" data-translate-placeholder="deploy_app_name_ph" placeholder="Your app name" required>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label class="form-label required" data-translate="deploy_directory_of_the_app">Directory of the app</label>
                            <input type="text" class="form-control" id="directory-app" placeholder="C:\xampp\htdocs\" required>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label class="form-label required" data-translate="deploy_script_of_the_app">Script of the app</label>
                            <div class="input-group input-group-flat">
                                <span class="input-group-text" id="directory-app-pre-value">
                                    C:\xampp\htdocs\
                                </span>
                                <input type="text" id="script-app" class="form-control ps-0" placeholder="src\index.js" autocomplete="off" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-9">
                        <div class="mb-3">
                            <label class="form-label" data-translate="deploy_name_space">Namespace</label>
                            <input type="text" class="form-control" id="namespace" data-translate-placeholder="deploy_name_space_ph" placeholder="Namespace of the app">
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="mb-3">
                            <label class="form-label" data-translate="deploy_watch_opt">Watch</label>
                            <select class="form-select" id="watch">
                                <option value="false" data-translate="deploy_watch_opt_false" selected>false</option>
                                <option value="true" data-translate="deploy_watch_opt_true">true</option>
                            </select>
                        </div>
                    </div>
                </div>
                <label class="form-label" data-translate="deploy_mode_type">Mode type</label>
                <div class="form-selectgroup-boxes row mb-3">
                    <div class="col-lg-6">
                        <label class="form-selectgroup-item">
                            <input type="radio" name="mode-type" value="1" class="form-selectgroup-input" checked>
                            <span class="form-selectgroup-label d-flex align-items-center p-3">
                                <span class="me-3">
                                    <span class="form-selectgroup-check"></span>
                                </span>
                                <span class="form-selectgroup-label-content">
                                    <span class="form-selectgroup-title strong mb-1" data-translate="deploy_mode_fork">Fork</span>
                                    <span class="d-block text-secondary" data-translate="deploy_mode_fork_details">Provide only basic instance for the process</span>
                                </span>
                            </span>
                        </label>
                    </div>
                    <div class="col-lg-6">
                        <label class="form-selectgroup-item">
                            <input type="radio" name="mode-type" value="2" class="form-selectgroup-input">
                            <span class="form-selectgroup-label d-flex align-items-center p-3">
                                <span class="me-3">
                                    <span class="form-selectgroup-check"></span>
                                </span>
                                <span class="form-selectgroup-label-content">
                                    <span class="form-selectgroup-title strong mb-1" data-translate="deploy_mode_cluster">Cluster</span>
                                    <span class="d-block text-secondary" data-translate="deploy_mode_cluster_details">Provide two instances for the process in cluster mode</span>
                                </span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                    <span data-translate="deploy_cancel">Cancel</span>
                </button>
                <button type="button" id="deploy-button" class="btn btn-pill bg-green-lt ms-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M5 12l5 5l10 -10" />
                    </svg>
                    <span data-translate="deploy">Deploy</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- modal new deploy -->
<!-- end page dashboard -->
<script>
    // Actualizar el campo de directory-app-pre-value cuando el usuario introduce un valor en directory-app
    document.getElementById('directory-app').addEventListener('input', function() {
        document.getElementById('directory-app-pre-value').textContent = this.value;
    });

    document.getElementById('deploy-button').addEventListener('click', async () => {
        // Capturamos los datos del formulario
        const appName = document.getElementById('app-name').value.trim();
        const directoryApp = document.getElementById('directory-app').value.trim();
        const scriptApp = directoryApp + document.getElementById('script-app').value.trim();
        const namespace = document.getElementById('namespace').value.trim();
        const watch = document.getElementById('watch').value === 'true';
        const modeType = document.querySelector('input[name="mode-type"]:checked').value;

        // Validamos que sean campos obligatorios
        if (!appName || !directoryApp || !scriptApp) {
            alert('Please fill in all required fields.');
            return;
        }

        // Definimos los datos a enviar
        const payload = {
            name: appName,
            script: scriptApp,
            namespace: namespace,
            watch: watch,
            modeType: modeType
        };

        try {
            const response = await fetch('/api/deploy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if(result.success) {
                alert('Deployment successful!');
                // Aquí puedes cerrar el modal y limpiar el formulario si es necesario
                $('#new-deploy').modal('hide');
            } else {
                alert('Deployment failed: ' + result.error);
            }
        } catch (error) {
            console.error('Error while deploying:', error);
            alert('An error occurred while deploying the app.');
        }
    });
</script>